services:
  neo4j:
    container_name: neo4j
    image: neo4j:latest
    hostname: 'neo4j'
    ports:
      - 7474:7474
      - 7687:7687
    environment:
      - NEO4J_apoc_export_file_enabled=true
      - NEO4J_apoc_import_file_enabled=true
      - NEO4J_AUTH=${NEO4J_USER}/${NEO4J_PASSWORD}
      - NEO4J_PLUGINS=["apoc", "apoc-extended"]
    volumes:
      - ./neo4j_db/data:/data
      - ./neo4j_db/logs:/logs
      - ./neo4j_db/import:/var/lib/neo4j/import
      - ./neo4j_db/plugins:/plugins
  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    hostname: 'rabbitmq'
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
     - ./rabbitmq/data/:/var/lib/rabbitmq/mnesia/
     - ./rabbitmq/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf
    healthcheck:
      # Pings rabbitmq service to check if started
      test: rabbitmq-diagnostics -q ping
      interval: 5s
      timeout: 5s
      retries: 5
  driller-worker:
    build: 
      context: ./
      dockerfile: ./driller/Dockerfile
    # network_mode: host
    volumes:
     - ./driller/repos:/app/driller/repos
     - ./driller/:/app/driller/
    deploy:
      replicas: 3
    # container_name: driller_worker
    depends_on:
      rabbitmq:
        # Wait for rabbitmq to be healthy
        condition: service_healthy
      neo4j:
        condition: service_started
    env_file:
      - .env
  backend:
    container_name: backend
    ports:
      - 8000:8000
    build: 
      context: ./
      dockerfile: ./backend/Dockerfile
    network_mode: host
    volumes:
     - ./backend/:/app/backend/
    depends_on:
      neo4j:
        condition: service_started
      driller-worker:
        condition: service_started
    env_file:
      - .env